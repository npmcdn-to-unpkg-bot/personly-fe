"use strict";var pmApp=angular.module("personly",["ngRoute","ngCookies","LocalStorageModule","customFilters","personly.factories","toastr","ngFileUpload","ui.bootstrap"]);pmApp.config(["$httpProvider",function(e){e.interceptors.push("pmHttpInterceptor")}]),pmApp.run(["$rootScope","$location","$window","pmAuth","$http",function(e,o,n,t,r){r.defaults.headers.common["x-access-token"]=t.getToken(),e.$on("$routeChangeSuccess",function(e){n.scrollTo(0,0),n.ga&&n.ga("send","pageview",{page:o.path()})}),e.$on("$routeChangeStart",function(e){angular.element("#navbar").removeClass("in")}),e.$on("$viewContentLoaded",function(){$(".nav a").click(function(){$(".navbar-collapse").hasClass("in")&&$('[data-toggle="collapse"]').click()})})}]),pmApp.config(["toastrConfig",function(e){angular.extend(e,{autoDismiss:!1,containerId:"toast-container",maxOpened:3,newestOnTop:!0,positionClass:"toast-bottom-left",preventDuplicates:!1,preventOpenDuplicates:!1,target:"body"})}]),pmApp.factory("pmHttpInterceptor",["localStorageService","$rootScope","$location","toastr",function(e,o,n,t){var r={};return r.request=function(o){var n=e.get("token");return n&&(o.headers["x-access-token"]=n),o},r.responseError=function(r){return console.log(r),403==r.status&&(e.clearAll(),n.path("/login"),o.currentUser={},o.loggedIn=!1,t.error("uh-oh! Something went wrong.\nPlease log back in again.")),r},r}]);var cf=angular.module("customFilters",[]);cf.filter("trusted",["$sce",function(e){return function(o){return e.trustAsHtml(o)}}]),pmApp.config(["$routeProvider","$locationProvider",function(e,o){o.html5Mode({enabled:!0,requireBase:!1}).hashPrefix("!");var n=function(e){return{templateUrl:e,controller:function(e,o,n){n.bgBlue=!0,n.$on("$routeChangeStart",function(e,o,t){n.bgBlue=!1})}}};e.when("/",{templateUrl:"/partials/landing.html",controller:"landingCtrl"}).when("/signup",{templateUrl:"/partials/signup.html",controller:"loginCtrl"}).when("/login",{templateUrl:"/partials/login.html",controller:"loginCtrl"}).when("/profile",{templateUrl:"/partials/user/profile.html",controller:"profileCtrl"}).when("/404",n("/partials/404.html")).otherwise({redirectTo:"/404"})}]),pmApp.controller("landingCtrl",["$scope","$rootScope","$location","$http","pmAuth",function(e,o,n,t,r){r.isSessionValid()&&n.path("/profile"),e.sendEmail=function(e){console.log(e);var o={name:e.name,email:e.email,subject:e.subject,message:e.message};t.post("/api/v1/submitEmail",o).success(function(e){console.log(e)}).error(function(e){console.log(e)})}}]),pmApp.controller("loginCtrl",["$scope","$rootScope","$location","$http","toastr","pmAuth","localStorageService",function(e,o,n,t,r,a,s){o.loggedIn&&n.path("/"),o.bgBlue=!0,o.$on("$routeChangeStart",function(e,n,t){o.bgBlue=!1}),e.signupUser=function(e){a.signupUser(e).then(function(e){e?r.success("Account successfully created."):r.error("Bummer... there is an error registering")})},e.loginUser=function(e){a.authenticateUser(e).then(function(e){e?r.success("Log In Successful"):r.error("Bummer... Incorrect username/password")})}}]),pmApp.controller("profileCtrl",["$scope","$rootScope","$location","$http","pmAuth","Upload",function(e,o,n,t,r,a){function s(){e.design.name="",e.design.tags="",e.design.description="",e.design.file="",e.progressPercentage=0,e.formLoading=!1}r.validateSession(),o.loggedIn&&n.path("/profile"),e.pageFullyLoaded=!1,e.max=100,e.progressPercentage=0,e.designUploadSuccess=!1,e.allDesigns=[],e.profileInit=function(){t.get("/api/v1/my-designs").success(function(o){console.log(o),e.allDesigns=o.designs,e.pageFullyLoaded=!0}).error(function(o){console.log(o),e.pageFullyLoaded=!0})},e.submitDesign=function(o){if(!(o&&o.name&&o.description&&o.tags))return void(e.designError="All the fields are mandatory.");var n=o.tags;n=n.split(",");var t=[];angular.forEach(n,function(e,o){""!==e.trim()&&13>o&&t.push(e.trim())}),o.tags=t,e.upload(o.file,o)},e.upload=function(o,n){console.log(n),a.upload({url:"/api/v1/user/upload",data:{file:o,data:n}}).then(function(o){console.log(o.data),o.data.success&&(console.log("upload successful"),e.designUploadSuccess=!0,e.designUploadSuccessMsg="Your Design have been uploaded successfully. It will be live as soon as one of our moderators approve the design.",e.uploadedDesign=o.data.design,e.allDesigns.push(o.data.design)),s()},function(o){e.formLoading=!1,console.log(o.data.message)},function(o){e.progressPercentage=parseInt(100*o.loaded/o.total),console.log("progress: "+e.progressPercentage+"% "+o.config.data.file.name),100==e.progressPercentage&&(e.formLoading=!0)})},e.imageUpload=function(e){console.log(e)},e.sendEmail=function(e){console.log(e);var o={name:e.name,email:e.email,subject:e.subject,message:e.message};t.post("/api/v1/submitEmail",o).success(function(e){console.log(e)}).error(function(e){console.log(e)})}}]);var pmFac=angular.module("personly.factories",[]);pmFac.factory("pmAuth",["$http","$q","localStorageService","$rootScope","$location",function(e,o,n,t,r){var a;return{signupUser:function(s){var l=o.defer();s.email=s.email.toLowerCase();var i={firstName:s.firstName,lastName:s.lastName,email:s.email,password:s.password};return e.post("/api/v1/signup",i).then(function(e){e.data.success?(t.currentUser=e.data.user,t.loggedIn=!0,n.set("user",e.data.user),n.set("token",e.data.token),a=e.data.token,r.url("/profile"),l.resolve(!0)):l.resolve(!1)}),l.promise},authenticateUser:function(s){var l=o.defer();s.username=s.username.toLowerCase();var i={username:s.username,password:s.password};return e.post("/api/v1/login",i).then(function(e){e.data.success?(t.currentUser=e.data.user,t.loggedIn=!0,n.set("user",e.data.user),n.set("token",e.data.token),a=e.data.token,r.url("/profile"),l.resolve(!0)):l.resolve(!1)}),l.promise},logoutUser:function(){var e=o.defer();return n.clearAll(),t.currentUser=null,t.loggedIn=!1,r.path("/"),e.resolve(),e.promise},validateSession:function(){var e=n.get("user"),o=n.get("token");o&&e?(t.currentUser=e,t.loggedIn=!0):this.invalidateSession()},isSessionValid:function(){var e=n.get("user"),o=n.get("token");return!(!o&&!e)},invalidateSession:function(e){n.clearAll(),t.loggedIn=!1,e?r.path(e):r.path("/login")},getToken:function(){return a||(a=n.get("token")),a}}}]),pmApp.controller("headerFooterCtrl",["$scope","$rootScope","$sce","$location","toastr","pmAuth",function(e,o,n,t,r,a){e.topNav=function(){$(window).scroll(function(){var e=$(window).scrollTop();e>100?$("#header").css({background:"rgba(0,114,255,.95)",padding:"5px 15px","box-shadow":"0px 1px 4px 0px rgba(150,150,150,.4)"}):100>e&&$("#header").css({background:"transparent",padding:"20px 15px","box-shadow":"none"})})},e.signout=function(){a.logoutUser()}}]);